generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                      Int           @id @default(autoincrement())
  email                   String        @unique
  password                String
  createdAt               DateTime      @default(now())
  updatedAt               DateTime      @updatedAt
  role                    Role
  provider                String?
  providerId              String?
  resetToken              String?       @unique
  resetTokenExpiry        DateTime?
  bio                     String?
  displayName             String        @unique
  goals                   Goal[]
  isUsernameAutoGenerated Boolean       @default(true)
  location                String?
  muscleGroups            MuscleGroup[]
  onboardingCompleted     Boolean       @default(false)
  profilePictureUrl       String?
  timezone                String?
  username                String        @unique
  workoutTypes            WorkoutType[]
  eventRegistrations      EventRegistration[] 
  
  // Gamification fields
  xp                      Int           @default(0)
  level                   Int           @default(0)
  rubies                  Int           @default(0)
  
  // ========== UPDATED: Gift tracking ==========
  fitneksTokens           Int           @default(0)  // NEW: Added for gift exchange
  protein                 Int           @default(0)  // NEW: Added for plain protein gift
  proteinShakes           Int           @default(0)
  proteinBars             Int           @default(0)
  // ============================================
  
  // Boost tracking
  profileBoosts           Int           @default(0)
  notifyBoosts            Int           @default(0)
  
  // Unlock tracking
  unlockedGifts           Json?         @default("{}")
  lastStreamCompletedAt   DateTime?
  
  // Payment fields
  stripeAccountId         String?       @unique
  stripeCustomerId        String?       @unique
  payouts                 Payout[]
  
  // Gift Exchange Withdrawals
  withdrawalRequests      WithdrawalRequest[]
  
  // ========== NEW: Gift Purchase History ==========
  giftPurchases           GiftPurchase[]  // NEW: Relation to purchase history
  // ================================================
  
  
  // Add these two lines at the bottom with your other relations:
  notificationPreferences     NotificationPreference[] @relation("LearnerNotifications")
  trainersNotifyingAbout      NotificationPreference[] @relation("TrainerNotifications")
  

  // Follower/Following relationships
  followers               Follows[]     @relation("UserFollowers")
  following               Follows[]     @relation("UserFollowing")
  
  // Profile visibility
  isPublic                Boolean       @default(true)
  
  // Live streaming status
  liveStatus              LiveStatus    @default(OFFLINE)
  
  // About section
  aboutMe                 String?
  
  // For events 
  events                  Event[]
  
  // Learner-specific fields
  weeklyGoal        Int      @default(50)
  
  // Muscle group points (store as JSON or separate table)
  armsPoints        Int      @default(0)
  chestPoints       Int      @default(0)
  backPoints        Int      @default(0)
  absPoints         Int      @default(0)
  legsPoints        Int      @default(0)
  challengePoints   Int      @default(0)
  
  // Learner Payment Relations
  paymentMethods    LearnerPaymentMethod[]
  rubyPurchases     RubyPurchase[]
  userRubies        UserRubies?

  // For tracking who sent gifts during live stream 
  livestreamGiftsSent LivestreamGift[] @relation("SentLivestreamGifts")

  // Live Stream Tracking 
  liveStreams         LiveStream[]
  streamParticipations StreamParticipation[]
  streamReviews        StreamReview[] @relation("StreamReviews") 

  // Ruby transfer relations (ADD THESE TWO LINES)
  sentRubyTransfers     RubyTransfer[] @relation("SentRubyTransfers")
  receivedRubyTransfers RubyTransfer[] @relation("ReceivedRubyTransfers")
  
  // Banned Users 
  bannedFromStreams BannedStreamParticipant[] @relation("BannedUser")
  bannedUsers       BannedStreamParticipant[] @relation("BanningTrainer")
  

  @@map("users")
}

model Payout {
  id          Int           @id @default(autoincrement())
  userId      Int
  user        User          @relation(fields: [userId], references: [id])
  amount      Int           // Amount in cents
  status      PayoutStatus  @default(PENDING)
  createdAt   DateTime      @default(now())
  completedAt DateTime?
  
  @@map("payouts")
}

model WithdrawalRequest {
  id                Int      @id @default(autoincrement())
  userId            Int
  user              User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  amountUSD         Float
  proteinShakesUsed Int
  proteinBarsUsed   Int
  status            String   @default("PENDING")
  stripePayoutId    String?
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  
  @@index([userId])
  @@index([createdAt])
  @@map("withdrawal_requests")
}

model LearnerPaymentMethod {
  id                    String         @id @default(cuid())
  userId                Int
  stripePaymentMethodId String         @unique
  cardBrand             String?
  cardLast4             String?
  cardExpMonth          Int?
  cardExpYear           Int?
  isDefault             Boolean        @default(false)
  createdAt             DateTime       @default(now())
  updatedAt             DateTime       @updatedAt

  user          User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  rubyPurchases RubyPurchase[]

  @@index([userId])
  @@index([stripePaymentMethodId])
  @@map("learner_payment_methods")
}

model RubyPurchase {
  id                    String                 @id @default(cuid())
  userId                Int
  rubiesAmount          Int
  costCents             Int
  stripePaymentIntentId String?                @unique
  paymentMethodId       String?
  status                String                 @default("pending")
  metadata              Json                   @default("{}")
  createdAt             DateTime               @default(now())
  updatedAt             DateTime               @updatedAt

  user          User                    @relation(fields: [userId], references: [id], onDelete: Cascade)
  paymentMethod LearnerPaymentMethod?   @relation(fields: [paymentMethodId], references: [id])

  @@index([userId])
  @@index([createdAt(sort: Desc)])
  @@index([status])
  @@map("ruby_purchases")
}

model UserRubies {
  id             String   @id @default(cuid())
  userId         Int      @unique
  balance        Int      @default(0)
  totalPurchased Int      @default(0)
  totalSpent     Int      @default(0)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("user_rubies")
}


model RubyTransfer {
  id           String    @id @default(cuid())
  createdAt    DateTime  @default(now())
  
  senderId     Int
  receiverId   Int
  livestreamId String
  amount       Int
  
  sender       User      @relation("SentRubyTransfers", fields: [senderId], references: [id], onDelete: Cascade)
  receiver     User      @relation("ReceivedRubyTransfers", fields: [receiverId], references: [id], onDelete: Cascade)
  
  @@index([senderId])
  @@index([receiverId])
  @@index([livestreamId])
  @@map("ruby_transfers")
}



// ========== NEW: Gift Purchase History Model ==========
model GiftPurchase {
  id           String       @id @default(cuid())
  createdAt    DateTime     @default(now())
  user         User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId       Int
  giftType     GiftType
  quantity     Int
  currencyUsed CurrencyType
  cost         Int          // Total tokens or rubies spent
  
  @@index([userId, createdAt])
  @@map("gift_purchases")
}
// ======================================================

model Follows {
  follower      User     @relation("UserFollowers", fields: [followerId], references: [id], onDelete: Cascade)
  followerId    Int
  following     User     @relation("UserFollowing", fields: [followingId], references: [id], onDelete: Cascade)
  followingId   Int
  createdAt     DateTime @default(now())
  
  @@id([followerId, followingId])
  @@map("follows")
}


model NotificationPreference {
  id           Int      @id @default(autoincrement())
  userId       Int      // The learner who wants notifications
  trainerId    Int      // The trainer they're following
  notifyOnLive Boolean  @default(true)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  
  user    User @relation("LearnerNotifications", fields: [userId], references: [id], onDelete: Cascade)
  trainer User @relation("TrainerNotifications", fields: [trainerId], references: [id], onDelete: Cascade)
  
  @@unique([userId, trainerId])
  @@index([trainerId, notifyOnLive])
  @@map("notification_preferences")
}


model Event {
  id                String       @id @default(cuid())
  trainer           User         @relation(fields: [trainerId], references: [id], onDelete: Cascade)
  trainerId         Int
  
  type              EventType
  status            EventStatus
  title             String
  description       String?      // âœ… ADD THIS LINE
  date              DateTime
  
  maxParticipants   Int?
  ticketValue       Float?
  giftsReceived     Float?
  xpEarned          Int?
  
  equipment         String[]
  trainingType      String
  pointsBreakdown   Json?
  duration          Int
  
  registrations     EventRegistration[]

  createdAt         DateTime     @default(now())
  updatedAt         DateTime     @updatedAt


  linkedLiveStream    LiveStream?
  
  @@map("events")
}



model EventRegistration {
  id            String   @id @default(cuid())
  userId        Int
  eventId       String
  registeredAt  DateTime @default(now())
  status        String   @default("registered") // registered, attended, cancelled
  
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  event         Event    @relation(fields: [eventId], references: [id], onDelete: Cascade)
  
  @@unique([userId, eventId])
  @@index([userId])
  @@index([eventId])
  @@map("event_registrations")
}



model LiveStream {
  id                String               @id @default(cuid())
  createdAt         DateTime             @default(now())
  updatedAt         DateTime             @updatedAt
  endedAt           DateTime?            

  title             String               @db.VarChar(50)
  description       String               @db.VarChar(200)
  status            LiveStreamStatus     @default(SCHEDULED)
  visibility        LiveStreamVisibility @default(PUBLIC)
  scheduledAt       DateTime
  maxParticipants   Int
  isRecurring       Boolean              @default(false)
  
  equipmentNeeded   Equipment[]
  workoutStyle      WorkoutStyle
  giftRequirement   Int                  @default(0)
  musclePoints      Json
  totalPossiblePoints Int

  trainer           User                 @relation(fields: [trainerId], references: [id], onDelete: Cascade)
  trainerId         Int

  parentStream      LiveStream?          @relation("RecurringStreams", fields: [parentStreamId], references: [id], onDelete: SetNull)
  parentStreamId    String?
  recurringStreams  LiveStream[]         @relation("RecurringStreams")

  participations    StreamParticipation[]
  
  giftsReceived     LivestreamGift[]

  bannedParticipants BannedStreamParticipant[]


  eventId           String?              @unique
  event             Event?               @relation(fields: [eventId], references: [id])

  @@index([trainerId])
  @@index([scheduledAt])
  @@index([status])
  @@map("live_streams")
}




model StreamParticipation {
  id              String      @id @default(cuid())
  userId          Int
  liveStreamId    String
  
  joinedAt        DateTime    @default(now())
  leftAt          DateTime?
  participationPct Float      @default(0)
  
  armsEarned      Int         @default(0)
  chestEarned     Int         @default(0)
  backEarned      Int         @default(0)
  absEarned       Int         @default(0)
  legsEarned      Int         @default(0)
  totalEarned     Int         @default(0)
  
  pointsCredited  Boolean     @default(false)
  
  user            User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  liveStream      LiveStream  @relation(fields: [liveStreamId], references: [id], onDelete: Cascade)
  
  @@unique([userId, liveStreamId])
  @@index([userId])
  @@index([liveStreamId])
  @@map("stream_participations")
}



model StreamReview {
  id           String   @id @default(cuid())
  createdAt    DateTime @default(now())
  
  userId       Int
  livestreamId String
  rating       Int      // 1-5 stars
  feedback     String?
  
  user         User     @relation("StreamReviews", fields: [userId], references: [id], onDelete: Cascade)
  
  @@unique([userId, livestreamId])
  @@index([livestreamId])
  @@map("stream_reviews")
}




model LivestreamGift {
  id           String   @id @default(cuid())
  createdAt    DateTime @default(now())
  
  senderId     Int
  livestreamId String
  giftType     GiftType
  quantity     Int      @default(1)
  
  sender       User       @relation("SentLivestreamGifts", fields: [senderId], references: [id], onDelete: Cascade)
  livestream   LiveStream @relation(fields: [livestreamId], references: [id], onDelete: Cascade)
  
  @@index([senderId, livestreamId])
  @@index([livestreamId, createdAt])
  @@map("livestream_gifts")
}



model BannedStreamParticipant {
  id             String     @id @default(cuid())
  livestreamId   String
  userId         Int
  participantSid String
  bannedAt       DateTime   @default(now())
  bannedBy       Int
  reason         String?
  
  livestream     LiveStream @relation(fields: [livestreamId], references: [id], onDelete: Cascade)
  user           User       @relation("BannedUser", fields: [userId], references: [id], onDelete: Cascade)
  banner         User       @relation("BanningTrainer", fields: [bannedBy], references: [id])
  
  @@unique([livestreamId, userId])
  @@index([livestreamId])
  @@index([userId])
  @@map("banned_stream_participants")
}




enum PayoutStatus {
  PENDING
  COMPLETED
  FAILED
}

enum Role {
  Trainer
  Learner
}

enum WorkoutType {
  Weights
  Calisthenics
  Resistance
  Yoga
  Pilates
  Dance
}

enum Goal {
  GainMuscle
  IncreaseFlexibility
  LoseWeight
}

enum MuscleGroup {
  Chest
  Back
  Arms
  Legs
  Abs
}

enum LiveStatus {
  LIVE
  OFFLINE
}

enum EventType {
  CLASS
  CHALLENGE
}

enum EventStatus {
  UPCOMING
  COMPLETED
}

// ========== NEW: Gift Exchange Enums ==========
enum GiftType {
  RUBY
  PROTEIN
  PROTEIN_SHAKE
  PROTEIN_BAR
}

enum CurrencyType {
  TOKENS
  RUBIES
}
// ==============================================


enum LiveStreamStatus {
  SCHEDULED
  LIVE
  ENDED
  CANCELED
}

enum LiveStreamVisibility {
  PUBLIC
  PRIVATE
}

enum Equipment {
  DUMBBELLS
  KETTLEBELL
  PLATES
  YOGA_BLOCK
  YOGA_MAT
  RESISTANCE_BAND
  PULL_UP_BAR
  NO_EQUIPMENT
}

enum WorkoutStyle {
  WEIGHTS
  CALISTHENICS
  RESISTANCE
  YOGA
  PILATES
  MOBILITY
}